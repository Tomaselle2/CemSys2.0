@using CemSys2.ViewModel
@model PersonasVM
@{
    ViewData["Title"] = "Personas ";
}
<h1 class="tituloDePagina">Personas</h1>

<div class="accordion" id="accordionDatosDifunto">
    <div class="accordion-item">
        <h2 class="accordion-header" id="panelsBuscardor-headingOne">
            <button class="accordion-button nueva-seccion acordeon-fijo" type="button" data-bs-target="#panelsBuscardor-collapseOne" aria-expanded="false" aria-controls="panelsBuscardor-collapseOne">
                Buscador
            </button>
        </h2>
        <div id="panelsBuscardor-collapseOne" class="accordion-collapse show" aria-labelledby="panelsBuscardor-headingOne" data-bs-parent="#accordionBuscardor">
            <div class="accordion-body">
                <div class="form-box">
                    <form asp-action="BuscarPersona" method="get" >
                        <div class="form-columns-container3">

                            <div>
                                <label for="dni">DNI</label>
                                <input class="form-control" id="dniInput" type="text" asp-for="Dni" pattern="[0-9]+" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                            </div>

                            <div>
                                <label for="nombreDifunto">Nombre</label>
                                <input class="form-control" id="nombreInput" type="text" asp-for="Nombre" maxlength="60" minlength="2" />
                            </div>

                            <div>
                                <label for="apellidoDifunto">Apellido</label>
                                <input class="form-control" type="text" id="apellidoInput" asp-for="Apellido" maxlength="60" minlength="2" />
                            </div>

                            <div>
                                <label>Condición</label>
                                <select class="form-select" asp-for="CondicionPersonaId" id="condicionPersona" asp-items="@(new SelectList(Model.ListaCondicionPersona, "Id", "Categoria"))">
                                    <option value="">--Elija una opción--</option>
                                </select>
                            </div>
                            <div id="selectTipoParcela" style="display:none;">
                                <label>Tipo de parcela</label>
                                <select asp-for="TipoParcelaId" id="tipoParcela" class="form-select" asp-items="@(new SelectList(Model.ListaTipoParcela, "Id", "TipoParcela1"))">
                                    <option value="">--Elija una opción--</option>
                                </select>
                            </div>
                            <div id="selectSeccion" style="display:none;">
                                <label>Sección</label>
                                <select asp-for="SeccionId" id="seccion" class="form-select" asp-items="@(new SelectList(Model.ListaSecciones, "Id", "Nombre"))">
                                    <option value="">--Elija una opción--</option>
                                </select>
                            </div>

                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-success me-2" id="btnBuscar">Buscar</button>
                                <a asp-action="Index" asp-controller="Personas" class="btn btn-primary" id="btnLimpiar">Limpiar filtros</a>
                            </div>
                        </div>
                    </form>
                    <form asp-action="ResultadosDifuntosExcel" asp-controller="Personas" method="get" id="formExcel">
                        <input type="hidden" name="Dni" value="@Model.Dni" />
                        <input type="hidden" name="Nombre" value="@Model.Nombre" />
                        <input type="hidden" name="Apellido" value="@Model.Apellido" />
                        <input type="hidden" name="CondicionPersonaId" value="@Model.CondicionPersonaId" />
                        <input type="hidden" name="TipoParcelaId" value="@Model.TipoParcelaId" />
                        <input type="hidden" name="SeccionId" value="@Model.SeccionId" />

                        <button type="submit" class="btn btn-success" id="buttonExcel"><i class="bi bi-file-earmark-spreadsheet"></i>  Excel</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Tabla -->

<div class="accordion" id="accordionPanelsStayOpenExample">
    <div class="accordion-item">
        <h2 class="accordion-header" id="panelsStayOpen-headingOne">
            <button class="accordion-button nueva-seccion acordeon-fijo" type="button" data-bs-toggle="" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                Resultados
            </button>
        </h2>
        <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-headingOne">
            @* cuerpo del acordion *@
            @if (Model.ListaPersonasIndex.Count != 0)
            {
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>DNI</th>
                                    <th>Apellido</th>
                                    <th>Nombre</th>
                                    <th>Sexo</th>
                                    <th>Condición</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var opc in Model.ListaPersonasIndex)
                                {
                                    <tr>
                                        <td>@(@opc.Dni == "nn" ? "--------" : opc.Dni)</td>
                                        <td>@opc.Apellido?.ToUpper()</td>
                                        <td>@opc.Nombre?.ToUpper()</td>
                                        <td>@opc.Sexo</td>
                                        @if(opc.CategoriaPersona == 1)
                                        {
                                            <td>Titular</td>
                                        }
                                        else
                                        {
                                            <td>Fallecido</td>
                                        }

                                        <td>
                                            <form asp-action="HistorialPersona" method="get" style="display: inline-block;" target="_blank">
                                                <input type="hidden" name="personaId" value="@opc.IdPersona" />
                                                <button type="submit" class="btn-modificar btn-sm" title="historial">
                                                    <i class="bi bi-clock-history"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>

                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                @* Paginador *@
                @if (Model.TotalPaginas > 1)
                {
                    @await Html.PartialAsync("_Paginador", new PaginadorViewModel
                    {
                        PaginaActual = Model.PaginaActual,
                        TotalPaginas = Model.TotalPaginas,
                        TotalRegistros = Model.TotalRegistros,
                        Accion = "BuscarPersona",
                        Controlador = "Personas"
                    })
                }

            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i>
                    Realice una búsqueda para ver los resultados. 
                </div>
            }
            @* Fin cuerpo del acordeon *@
        </div>
    </div>
</div>


<script>
    //maneja la aparicion y desaparicion de los select de tipo parcela y seccion
    document.getElementById('condicionPersona').addEventListener('change', function () {
        const condicion = this.value;
        const tipoParcela = document.getElementById('selectTipoParcela');
        const seccion = document.getElementById('selectSeccion');

        if (condicion === "2") {
            tipoParcela.style.display = 'block';
            seccion.style.display = 'block';
        } else {
            tipoParcela.style.display = 'none';
            seccion.style.display = 'none';
        }
    });
</script>

<script>
    const condicionSelect = document.getElementById('condicionPersona');
    const tipoParcelaDiv = document.getElementById('selectTipoParcela');
    const seccionDiv = document.getElementById('selectSeccion');
    const tipoParcelaSelect = document.getElementById('tipoParcela');
    const seccionSelect = document.getElementById('seccion');

    // Función reutilizable para mostrar/ocultar
    function toggleCamposTipoParcela() {
        const condicion = condicionSelect.value;
        if (condicion === "2") {
            tipoParcelaDiv.style.display = 'block';
            seccionDiv.style.display = 'block';
        } else {
            tipoParcelaDiv.style.display = 'none';
            seccionDiv.style.display = 'none';
        }
    }

    condicionSelect.addEventListener('change', function () {
        toggleCamposTipoParcela();
    });

    tipoParcelaSelect.addEventListener('change', async function () {
        const tipoParcelaId = this.value;
        seccionSelect.innerHTML = '<option value="">--Seleccione una sección--</option>';

        if (tipoParcelaId) {
            try {
                const response = await fetch(`/Personas/ObtenerSeccionesPorTipo?tipoParcelaId=${tipoParcelaId}`);
                if (response.ok) {
                    const secciones = await response.json();

                    if (secciones.length > 0) {
                        secciones.forEach(seccion => {
                            const option = document.createElement('option');
                            option.value = seccion.id;
                            option.text = seccion.nombre.toUpperCase();
                            seccionSelect.appendChild(option);
                        });
                        // ✅ Si tenías un SeccionId seleccionado, mantenerlo seleccionado:
                        const seccionId = '@Model.SeccionId';
                        if (seccionId && seccionId !== "0") {
                            seccionSelect.value = seccionId;
                        }
                    } else {
                        const option = document.createElement('option');
                        option.text = 'No hay secciones disponibles';
                        seccionSelect.appendChild(option);
                    }
                }
            } catch (error) {
                console.error('Error al obtener secciones:', error);
            }
        }
    });

    // ✅ Al cargar la página
    document.addEventListener('DOMContentLoaded', function () {
        toggleCamposTipoParcela();
        // Si ya hay un tipoParcela seleccionado, dispará el cambio para cargar secciones:
        const tipoParcelaId = tipoParcelaSelect.value;
        if (condicionSelect.value === "2" && tipoParcelaId) {
            tipoParcelaSelect.dispatchEvent(new Event('change'));
        }
    });

</script>
